#!/bin/bash
#PBS -N test_hpo_pattern
#PBS -l walltime=1:00:00
#PBS -l select=1:ncpus=4:mem=16gb:ngpus=1:gpu_type=RTX6000
#PBS -j oe

# Test EXACT HPO Pattern for Ablation

echo "🧪 Testing EXACT HPO Pattern for Ablation"
echo "Node: $(hostname)"
echo "Date: $(date)"

# Initialize conda (EXACT same as HPO)
source ~/miniforge3/etc/profile.d/conda.sh

# Change to submission directory (EXACT same as HPO)
cd $PBS_O_WORKDIR

# Verify we're in the right directory (EXACT same as HPO)
echo "Working directory: $(pwd)"
echo "Contents: $(ls -la | head -5)"

# Activate conda environment (EXACT same as HPO)
conda activate everest_env

echo "Test job: Validating exact HPO pattern for ablation"
echo "Using GPU: $CUDA_VISIBLE_DEVICES"
echo "Conda environment: $CONDA_DEFAULT_ENV"
echo "Python executable: $(which python)"
echo "Python version: $(python --version)"

# Test imports (EXACT same as HPO)
echo "Testing imports..."
python -c "
import torch
print(f'PyTorch version: {torch.__version__}')
print('Ablation imports successful')
"

# Validate GPU (EXACT same as HPO)
echo "Validating GPU..."
python -c "
import torch
if torch.cuda.is_available():
    gpu_name = torch.cuda.get_device_name(0)
    print(f'✅ GPU available: {gpu_name}')
else:
    print('❌ GPU not available - ablation cannot proceed')
    exit(1)
"

if [ $? -ne 0 ]; then
    echo "❌ GPU validation failed"
    exit 1
fi

# Test data loading (EXACT same as HPO)
echo "Testing data loading..."
python -c "
import sys
from pathlib import Path
project_root = Path.cwd()
sys.path.insert(0, str(project_root))
print(f'Project root: {project_root}')

try:
    from models.utils import get_training_data, get_testing_data
    print('✅ Successfully imported data functions')
except Exception as e:
    print(f'❌ Import failed: {e}')
    exit(1)

print('Loading training data...')
X_train, y_train = get_training_data('72', 'M5')
if X_train is None or y_train is None:
    print('❌ Training data not found')
    exit(1)
print(f'✅ Training data: {len(X_train)} samples, shape {X_train[0].shape if len(X_train) > 0 else \"unknown\"}')

print('Loading testing data...')
X_test, y_test = get_testing_data('72', 'M5')
if X_test is None or y_test is None:
    print('❌ Testing data not found')
    exit(1)
print(f'✅ Testing data: {len(X_test)} samples, shape {X_test[0].shape if len(X_test) > 0 else \"unknown\"}')

import numpy as np
X_train = np.array(X_train)
y_train = np.array(y_train)
print(f'Training X shape: {X_train.shape}, dtype: {X_train.dtype}')
print(f'Training y shape: {y_train.shape}, dtype: {y_train.dtype}')
print(f'Positive class ratio: {y_train.mean():.4f}')
print('✅ All tests passed - exact HPO pattern works!')
"

if [ $? -ne 0 ]; then
    echo "❌ Data loading test failed"
    exit 1
fi

# Test quick ablation run (EXACT same pattern as HPO)
echo "🎯 Testing quick ablation run..."
python models/ablation/run_ablation_exact_hpo.py --variant full_model --seed 0 || {
    echo "❌ Ablation test failed"
    exit 1
}

echo "✅ All tests passed - exact HPO pattern works for ablation!"
echo "🏁 Test completed at $(date)" 